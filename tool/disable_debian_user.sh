#!/usr/bin/env bash
# disable_debian_user.sh
# 功能：禁用 debian 账号＋杀进程＋更新 SSH & cloud-init
# 使用：root 登录后 ./disable_debian_user.sh

set -euxo pipefail
exec > >(tee -a ~/disable_debian.log) 2>&1

TARGET=debian                    # 要禁用的账号

###############################################################################
# 1️⃣ 终止该用户的所有进程和会话
###############################################################################
pkill   -u "$TARGET"          || true
loginctl terminate-user "$TARGET" || true

###############################################################################
# 2️⃣ 锁定账号：密码 / Shadow / Shell
###############################################################################
passwd  -l "$TARGET"                          # 锁密码
usermod -L "$TARGET"                          # 锁 shadow
chsh -s /usr/sbin/nologin "$TARGET"           # 置无交互 shell

###############################################################################
# 3️⃣ 移除 sudo 权限
###############################################################################
deluser "$TARGET" sudo || true

###############################################################################
# 4️⃣ SSH 层面再加保险
###############################################################################
SSH_CFG=/etc/ssh/sshd_config
if ! grep -q "^DenyUsers" "$SSH_CFG"; then
    echo "DenyUsers $TARGET" >> "$SSH_CFG"
else
    sed -Ei "s/^(DenyUsers.*)/\1 $TARGET/" "$SSH_CFG"
fi
systemctl reload ssh                       # Debian 中的服务名

###############################################################################
# 5️⃣ cloud-init：禁止再次创建 / 启用 debian 账户
###############################################################################
CFG=/etc/cloud/cloud.cfg
sed -Ei 's/^( *name:).*/\1 root/'          "$CFG"
sed -Ei 's/^( *lock_password:).*/\1 true/' "$CFG"

###############################################################################
echo "[ OK ] 账号 $TARGET 已被彻底禁用并从登录列表移除。"
###############################################################################